(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{501:function(e,n,t){"use strict";t.r(n);var a=t(1),r=t(440),i=t(135),d=t(441),l=t(509),o=t(439),s=t(0);n.default=function(){return Object(s.d)(d.a,null,Object(s.d)(r.a,null,Object(s.d)(i.a,null,Object(s.d)("h1",null,"Guide: middleware"),Object(s.d)(l.c,null,"Middleware provides powerful additional functionality to how APIs behave. This guide goes through how middleware is used and created."),Object(s.d)(l.b,{content:[{heading:"What is middleware?",anchor:"whatis",content:Object(s.d)(a.Fragment,null,Object(s.d)("p",null,"Much like express middleware, papupata middleware exists to separate common functionality needed by APIs from the actual API implementations."),Object(s.d)("p",null,"There are two types of middleware:"),Object(s.d)("ul",null,Object(s.d)("li",null,"Middleware inherent to an API declaration, which is applied to all of the declared APIs. This could be called global middleware, but since it only applies to a single API declaration it could be misleading."),Object(s.d)("li",null,"API-specific middleware, which is only applied when explicitly requested.")),Object(s.d)("p",null,"The middleware generally speaking do one or all of the following things:"),Object(s.d)("ul",null,Object(s.d)("li",null,"Manipulate the request before passing it along to the API implementation"),Object(s.d)("li",null,"Preventing the API from being called under specific circumstances"),Object(s.d)("li",null,"Manipulate the output of an API"),Object(s.d)("li",null,"Add a side-effect to an API being invoked")))},{heading:"Using middleware",anchor:"using",content:Object(s.d)(a.Fragment,null,Object(s.d)("p",null,"Both inherent and route-specific middleware is given in an array. The order of the elements matters: inherent middleware is always processed before route-specific middleware, and within the array all middleware are processed in the same order as they exist in the array. This can be important if, say, one middleware adds data to request another middleware depends on, or if you want to block the execution of the middleware as well based on a condition."),Object(s.d)("p",null,"Configuring inherent middleware: "),Object(s.d)(o.c,null,"\n                    API.configure({\n                      ...API.getConfig(),\n                      inherentMiddleware: [myMiddleware1, myMiddleware1]\n                    })\n                  "),Object(s.d)("p",null,"Configuring middleware for a single route: "),Object(s.d)(o.c,null,"\n                    const myAPI = API.declareGetAPI('/test').response<string>()\n\n                    myAPI.implementWithPapupataMiddleware([myMiddleware1, myMiddleware1], implementation)\n                  "),Object(s.d)("p",null,"You can use express middleware with papupata, see more in the ",Object(s.d)("a",{href:"#express"},"express section of this guide"),"."))},{heading:"The most basic middleware",anchor:"basic",content:Object(s.d)(a.Fragment,null,Object(s.d)("p",null,"Let's start by creating a middleware that simply logs the URLs being invoked."),Object(s.d)(o.c,null,"\n                import {PapupataMiddleware} from 'papupata'\n                import {Request} from 'express'\n                const myMiddleware: PapupataMiddleware<Request, void> = (req, res, api, next) => {\n                    console.log('Handling', req.url)\n                    return next()\n                }\n                "),Object(s.d)("p",null,"The main difference between express and papupata middleware is that while express middleware forms a list, papupata middleware are more like koa middleware in that there is a call stack, or a pyramid where each middleware can be a part of both the request and the response. The important thing for most middleware is to return the value returned by calling"," ",Object(s.d)(l.a,null,"next()")," instead ignoring it."),Object(s.d)("p",null,"Errors are handled by throwing exceptions."))},{heading:"Manipulating request",anchor:"request",content:Object(s.d)(a.Fragment,null,Object(s.d)("p",null,"In theory manipulating the request is just changing data in it."),Object(s.d)(o.c,null,"\n                const myMiddleware: PapupataMiddleware<Request, void> = (req, res, api, next) => {\n                    if (req.body?.userId === 'self') {\n                        req.body.userId = req.session.userId\n                    }\n                    return next()\n                }\n                "),Object(s.d)("p",null,"Typescript does make some kinds of changes more difficult. If you want to add custom fields, you probably want to extend the ",Object(s.d)(l.a,null,"request")," interface to contain whatever you are adding."),Object(s.d)("p",null,"Sometimes though these modifications might only be relevant for single papupata API declarations and you don't want to change the global request interface. For this reason papupata supports changing the request type to something other than the default."),Object(s.d)(o.c,null,"\n                  interface MyRequest extends Request {\n                    myField: string\n                  }\n\n                  const API = new APIDeclaration<MyRequest>()\n\n                   const myMiddleware: PapupataMiddleware<MyRequest, void> = (req, res, api, next) => {\n                    if (req.body?.userId === 'self') {\n                        req.body.userId = req.session.userId\n                    }\n                    return next()\n                }\n                  "),Object(s.d)("p",null,"In the example both the implementations and middleware on API use the MyRequest instead of the normal Request type for the request parameter."))},{heading:"Abandoning the request",anchor:"abandoning",content:Object(s.d)(a.Fragment,null,Object(s.d)("p",null,"Sometimes middleware needs to prevent the actual implemementation from being called. There are multiple way to do this depending on what your goal is. There is always one thing in common though: you don'd call next."),Object(s.d)("ul",null,Object(s.d)("li",null,"Return a value. It then becomes the response instead of what the implementation would have provided",Object(s.d)(o.c,null,"\n                    const myMiddleware: PapupataMiddleware<MyRequest, void> = (req, res, api, next) => {\n                      if (!req.headers.accept?.includes('application/json')) {\n                          res.status(400)\n                          return 'Bad headers'\n                      }\n                      return next()\n                    }\n                    ")),Object(s.d)("li",null,"Throw an error to do normal error handling",Object(s.d)(o.c,null,"\n                    const myMiddleware: PapupataMiddleware<MyRequest, void> = (req, res, api, next) => {\n                      if (!req.headers.accept?.includes('application/json')) {\n                          throw new Error('Bad headers')\n                      }\n                      return next()\n                    }\n                    ")),Object(s.d)("li",null,"Explicitly send a response using the methods on ",Object(s.d)(l.a,null,"res"),". This prevents other middleware from being able to affect the response.",Object(s.d)(o.c,null,"\n                    const myMiddleware: PapupataMiddleware<MyRequest, void> = (req, res, api, next) => {\n                      if (!req.headers.accept?.includes('application/json')) {\n                          res.status(400)\n                          res.send('Bad request: Invalid headers')\n                          return\n                      }\n                      return next()\n                    }\n                    ")),Object(s.d)("li",null,"Return ",Object(s.d)(l.a,null,"skipHandlingRoute")," to have express resume routing and middleware processing with other APIs.",Object(s.d)(o.c,null,"\n                    import {skipHandlingRoute} from 'papupata'\n                    const myMiddleware: PapupataMiddleware<MyRequest, void> = (req, res, api, next) => {\n                      if (!req.headers.accept?.includes('application/json')) {\n                          return skipHandlingRoute\n                      }\n                      return next()\n                    }\n                    "))))},{heading:"Manipulating response",anchor:"response",content:Object(s.d)(a.Fragment,null,Object(s.d)("p",null,"Normally a middleware gets the response data by doing ",Object(s.d)(l.a,null,"await next()"),", and it can then do whatever manipulation it desires. Some APIs can send the response directly though, in which case this is not true, so you should try and be prepared for it."),Object(s.d)(o.c,null,"\n                    const myMiddleware: PapupataMiddleware<MyRequest, void> = async (req, res, api, next) => {\n                      const value = await next()\n                      if (!res.headersSent) {\n                        res.status(204)\n                        return value ?? 'No data'\n                      }\n                      return value\n                    }\n                  "))},{heading:"Route options",anchor:"options",content:Object(s.d)(a.Fragment,null,Object(s.d)("p",null,"It'd be really convenient to give middleware some metadata about a route. Is unauthenticated access permitted? Does it handle unusual payloads? Papupata allows exactly that."),Object(s.d)("p",null,"When you create an API declaration you can provide an interface that provides options to routes, and provide a value of that type to the APIs."),Object(s.d)(o.c,null,"\n                  import {Request} from 'express'\n                  interface Options { publicAccess: boolean }\n                  const API = new APIDeclaration<Request, Options>()\n                  const myAPI = API.declareGetAPI('/api/ping', {publicAccess: true}).response<string>()\n                "),Object(s.d)("p",null,"This value can then be accessed by middleware."),Object(s.d)(o.c,null,"\n                    const myMiddleware: PapupataMiddleware<Request, Options> = async (req, res, api, next) => {\n                      if (!api.options?.publicAccess && !req.session.isValid) {\n                        throw new Error('Authentication required')\n                      }\n                      return next()\n                    }\n                "))},{heading:"Error handling",anchor:"errors",content:Object(s.d)(a.Fragment,null,Object(s.d)("p",null,"You can use middleware to add custom error handling."),Object(s.d)(o.c,null,"\n                    const myMiddleware: PapupataMiddleware<Request, Options> = async (req, res, api, next) => {\n                      try {\n                        return await next()\n                      } catch(err) {\n                        res.status(err.status || 400)\n                        return err.message\n                      }\n                    }\n                "))},{heading:"Express middleware",anchor:"express",content:Object(s.d)(a.Fragment,null,Object(s.d)("p",null,"Individual routes can be given express middleware in addition to papupata middleware. If you do that, the express middleware is run before the papupata middleware is -- even the inherent middleware."),Object(s.d)(o.c,null,"\n                myAPI.implementWithExpressMiddleware([expressMiddleware], implement)\n                myAPI.implementWithMiddleware({express: [expressMiddleware]}, implement)\n                "),Object(s.d)("p",null,"A generally preferable option is to convert express middleware into papupata middleware;"," ",Object(s.d)(l.a,null,"convertExpressMiddleware")," is exported by papupata to do that. At this time it does not handle express middleware that handle errors, but other middleware should be convertable."),Object(s.d)(o.c,null,"\n                  import {convertExpressMiddleware} from 'papupata'\n                  myAPI.implementWithPapupataMiddleware([convertExpressMiddleware(expressMiddleware)], implement)\n                  "))}]}))))}},509:function(e,n,t){"use strict";t.d(n,"c",(function(){return u})),t.d(n,"b",(function(){return h})),t.d(n,"a",(function(){return m}));t(510),t(1);var a=t(439),r=t(4),i=t(0);function d(){var e=s(['\n  font-family: "Consolas", "Bitstream Vera Sans Mono", "Courier New", Courier, monospace\n']);return d=function(){return e},e}function l(){var e=s(["\n  font-size: 1.1em;\n"]);return l=function(){return e},e}function o(){var e=s([""]);return o=function(){return e},e}function s(e,n){return n||(n=e.slice(0)),e.raw=n,e}function u(e){var n=e.children;return Object(i.d)(a.j,null,Object(i.d)(a.k,null,"Overview"),n)}var c=r.a.h4(o()),p=r.a.h5(l());function h(e){var n=e.content;return Object(i.d)("div",null,Object(i.d)(a.j,null,Object(i.d)(a.k,null,"Table of contents"),Object(i.d)("ul",null,n.map((function(e){return Object(i.d)("li",{style:{marginLeft:18*(e.level||0)},key:e.anchor},Object(i.d)("a",{href:"#"+e.anchor},e.heading))})))),n.map((function(e){var n=e.level?p:c;return Object(i.d)(a.j,{id:e.anchor,key:e.anchor},Object(i.d)(n,null,e.heading),e.content)})))}var m=r.a.span(d())},510:function(e,n,t){"use strict";t(109)("anchor",(function(e){return function(n){return e(this,"a","name",n)}}))}}]);
//# sourceMappingURL=component---src-pages-guides-server-middleware-tsx-5e8747a7ef04ae8e3cd3.js.map