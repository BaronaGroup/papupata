{"version":3,"sources":["webpack:///./src/pages/guides/server/testing.tsx","webpack:///./src/components/IncludeAvailableFromContext.tsx","webpack:///./src/components/api-components.tsx","webpack:///./src/components/guides.tsx"],"names":["IndexPage","content","heading","anchor","level","IncludeAvailableFromContext","React","Section","styled","section","SectionHeading","h4","SubHeading","h5","ExampleCommonContainer","Purpose","children","AvailableFrom","version","Usage","Parameters","includeAvailableFrom","label","Provider","value","Parameter","name","dataType","availableFrom","useContext","MethodReturnType","Caveats","Examples","Example","language","ExampleCommon","TypeParameters","Row","tr","NameColumn","td","DefaultValueColumn","DescriptionColumn","AvailableFromColumn","TypeParameter","defaultValue","Overview","Level0","Level1","GuideContent","map","child","style","marginLeft","key","href","Heading","id","FixedFont","span"],"mappings":"8FAAA,+FA0NeA,UAlNG,kBAChB,YAAC,IAAD,KACE,YAAC,IAAD,KACE,YAAC,IAAD,KACE,6CACA,YAAC,IAAD,qHACA,YAAC,IAAD,CACEC,QAAS,CACP,CACEC,QAAS,kBACTC,OAAQ,SACRF,QACE,uBACE,+FACA,YAAC,IAAD,8hBAgBN,CACEC,QAAS,aACTC,OAAQ,SACRF,QACE,4BACE,mMAIA,0LAIA,YAAC,IAAD,wOAMA,0YAMA,6DAIN,CACEC,QAAS,kCACTC,OAAQ,iBACRF,QACE,4BACE,yLAE2C,YAAC,IAAD,2BAF3C,wJAKA,YAAC,IAAD,+GAGA,8GAIN,CACEC,QAAS,0CACTC,OAAQ,oBACRC,MAAO,EACPH,QACE,4BACE,wdAMA,0RAKA,YAAC,IAAD,oeASA,wFACA,sBACE,sBACE,YAAC,IAAD,sBADF,4EAEE,YAAC,IAAD,2NAMF,sBACE,YAAC,IAAD,uBADF,iEAEE,YAAC,IAAD,kNAMF,sBACE,YAAC,IAAD,uBADF,wDAEE,YAAC,IAAD,8KAUV,CACEC,QAAS,iDACTC,OAAQ,mBACRC,MAAO,EACPH,QACE,4BACE,0UAKA,YAAC,IAAD,uOAIA,mHACA,YAAC,IAAD,wHAMN,CACEC,QAAS,mBACTC,OAAQ,aACRF,QACE,4BACE,iIACA,mMAIA,YAAC,IAAD,sdASA,0GACA,YAAC,IAAD,ilBAWA,uIACA,YAAC,IAAD,ipB,oCClMlB,kDAEaI,EAA8BC,iBAAoB,I,qvCCGxD,IAAMC,EAAUC,IAAOC,QAAV,KACPC,EAAiBF,IAAOG,GAAV,KACdC,EAAaJ,IAAOK,GAAV,KACVC,EAAyBN,IAAOC,QAAV,KAKtBM,EAAoB,SAAC,GAAiB,IAAfC,EAAe,EAAfA,SAClC,OACE,YAACT,EAAD,KACE,YAACG,EAAD,gBACCM,IAMMC,EAAgB,SAAC,GAA4C,IAA1CC,EAA0C,EAA1CA,QAC9B,OACE,YAACX,EAAD,KACE,YAACG,EAAD,qBADF,yDAEyDQ,EAFzD,cAOSC,EAAkB,SAAC,GAAiB,IAAfH,EAAe,EAAfA,SAChC,OACE,YAACT,EAAD,KACE,YAACG,EAAD,cACCM,IAIMI,EAA2E,SAAC,GAA8C,IAA5CJ,EAA4C,EAA5CA,SAAUK,EAAkC,EAAlCA,qBAAsBC,EAAY,EAAZA,MACzH,OACE,YAACf,EAAD,KACE,YAAC,IAA4BgB,SAA7B,CAAsCC,QAASH,GAC7C,YAACX,EAAD,kBAA2BY,GAAS,KAAKA,GACxCN,EACC,yBACE,yBACE,sBACE,8BACA,8BACA,qCACCK,GAAwB,yCAG7B,yBAAQL,IAGV,oDAOGS,EAAsF,SAAC,GAK9F,IAJJT,EAII,EAJJA,SACAU,EAGI,EAHJA,KACAC,EAEI,EAFJA,SAEI,IADJC,qBACI,MADY,QACZ,EACEP,EAAuBf,IAAMuB,WAAWxB,KAC9C,OACE,sBACE,sBAAKqB,GACL,sBAAKC,GACL,sBAAKX,GACJK,GAAwB,sBAAKO,KAKvBE,EAA6B,SAAC,GAAiB,IAAfd,EAAe,EAAfA,SAC3C,OACE,YAACT,EAAD,KACE,YAACG,EAAD,gBACCM,IAKMe,EAAoB,SAAC,GAAiB,IAAff,EAAe,EAAfA,SAClC,OACE,YAACT,EAAD,KACE,YAACG,EAAD,gBACCM,IAIMgB,EAAwC,SAAC,GAAiB,IAAfhB,EAAe,EAAfA,SACtD,OACE,YAACT,EAAD,KACE,YAACG,EAAD,iBACCM,IAKMiB,EAA0D,SAAC,GAAwB,IAAtBjB,EAAsB,EAAtBA,SAAUM,EAAY,EAAZA,MAClF,OACE,8BACGA,GAAS,YAACV,EAAD,KAAaU,GACvB,YAAC,IAAD,CAAMY,SAAU,cAAelB,KAKxBmB,EAA6C,SAAC,GAAiB,IAAfnB,EAAe,EAAfA,SAC3D,OACE,YAACF,EAAD,KACE,YAACF,EAAD,kCACCI,IAKMoB,EAAoF,SAAC,GAAuC,IAArCpB,EAAqC,EAArCA,SAAUK,EAA2B,EAA3BA,qBAC5G,OACE,YAACd,EAAD,KACE,YAACG,EAAD,yBACA,YAAC,IAA4Ba,SAA7B,CAAsCC,QAASH,GAC7C,YAACX,EAAD,mBACCM,EACC,yBACE,yBACE,sBACE,8BACA,uCACA,qCACCK,EAAuB,uCAAyB,KAGrD,yBAAQL,IAGV,oDAOJqB,EAAM7B,IAAO8B,GAAV,KACHC,EAAa/B,IAAOgC,GAAV,KACVC,EAAqBjC,IAAOgC,GAAV,KAClBE,EAAoBlC,IAAOgC,GAAV,KACjBG,EAAsBnC,IAAOgC,GAAV,KAEZI,EAA2F,SAAC,GAKnG,IAJJ5B,EAII,EAJJA,SACAU,EAGI,EAHJA,KACAmB,EAEI,EAFJA,aAEI,IADJjB,qBACI,MADY,OACZ,EACEP,EAAuBf,IAAMuB,WAAWxB,KAC9C,OACE,YAACgC,EAAD,KACE,YAACE,EAAD,KAAab,GACb,YAACe,EAAD,KAAqBI,GACrB,YAACH,EAAD,KAAoB1B,GACnBK,EAAuB,YAACsB,EAAD,KAAsBf,GAAuC,M,0gBCtKpF,SAASkB,EAAT,GAAyD,IAArC9B,EAAqC,EAArCA,SACzB,OACE,YAAC,IAAD,KACE,YAAC,IAAD,iBACCA,GAYP,IAAM+B,EAASvC,IAAOG,GAAV,KACNqC,EAAQxC,IAAOK,GAAT,KAIL,SAASoC,EAAT,GAA6D,IAArChD,EAAqC,EAArCA,QAC7B,OACE,uBACE,YAAC,IAAD,KACE,YAAC,IAAD,0BACA,sBACGA,EAAQiD,KAAI,SAAAC,GAAK,OAChB,kBAAIC,MAAO,CAAEC,WAAY,IAAMF,EAAM/C,OAAS,IAAMkD,IAAKH,EAAMhD,QAC7D,iBAAGoD,KAAI,IAAMJ,EAAMhD,QAAWgD,EAAMjD,eAK3CD,EAAQiD,KAAI,SAAAC,GACX,IAAMK,EAAWL,EAAM/C,MAAiB4C,EAATD,EAC/B,OACE,YAAC,IAAD,CAASU,GAAIN,EAAMhD,OAAQmD,IAAKH,EAAMhD,QACpC,YAACqD,EAAD,KAAUL,EAAMjD,SACfiD,EAAMlD,aAQZ,IAAMyD,EAAYlD,IAAOmD,KAAV","file":"component---src-pages-guides-server-testing-tsx-1406aba93c0341edb7f2.js","sourcesContent":["import * as React from 'react'\nimport { Example } from '../../../components/api-components'\nimport Container from '../../../components/Container'\nimport { FixedFont, GuideContent, Overview } from '../../../components/guides'\nimport Page from '../../../components/Page'\nimport IndexLayout from '../../../layouts'\n\n\nconst IndexPage = () => (\n  <IndexLayout>\n    <Page>\n      <Container>\n        <h1>Guide: testing APIs</h1>\n        <Overview>Testing can be tricky. This guide provides some ideas on how you could test APIs implemented using papupata.</Overview>\n        <GuideContent\n          content={[\n            {\n              heading: 'Before starting',\n              anchor: 'before',\n              content: (\n                <div>\n                  <p>The following is assumed to be present for the examples in this guide:</p>\n                  <Example>{`\n                  import {APIDeclaration} from 'papupata'\n                  const API = new APIDeclaration()\n\n                  const complexAPI = API.declarePostAPI('/update/:id', routeOptions)\n                    .params(['id'] as const)\n                    .query(['author'] as const)\n                    .optionalQuery(['timestamp'] as const)\n                    .queryBool(['notifyWatchers'] as const)\n                    .body<{ name: string}>()\n                    .response<{status: string }>()\n                `}</Example>\n                </div>\n              )\n            },\n\n            {\n              heading: 'The Basics',\n              anchor: 'basics',\n              content: (\n                <>\n                  <p>\n                    As papupata is typically used as a part of an express application you always have the option of using whatever tools you\n                    use to test the rest of your express application.\n                  </p>\n                  <p>\n                    The key to doing this is setting up a base URL on the papupata APIDeclaration and then using the getURL method of the\n                    individual APIs to figure out what to call.\n                  </p>\n                  <Example>{`\n                    API.configure({baseURL: 'http://localhost:3000'})\n\n                    const response = await request.post(api.getURL({}))\n                    expect(request).toEqual({ok: true})\n                  `}</Example>\n                  <p>\n                    There are a few downsides to doing this, though. For one, you are not taking advantage of types present in the APIs, so\n                    typescript will not be able to warn you if you are sending invalid data to the API. Second, by having the whole express\n                    application present you are testing the whole server implementation, including middleware, even if you wanted to do unit\n                    testing.\n                  </p>\n                  <p>Let's look into some other options</p>\n                </>\n              )\n            },\n            {\n              heading: 'Just testing the implementation',\n              anchor: 'implementation',\n              content: (\n                <>\n                  <p>\n                    For the purpose of unit testing, you'll probably want to test just the implementation of the API. Once implemented, the\n                    actual implementation can be accessed as <FixedFont>api.implementation</FixedFont>. You can call it directly from your\n                    tests, although you might find it inconvenient because you have to supply request and response to the function.\n                  </p>\n                  <Example>{`\n                    const response = await api.implementation(request, response)\n                  `}</Example>\n                  <p>In practice, you'll want a helper of some kind to deal with setting up the objects.</p>\n                </>\n              )\n            },\n            {\n              heading: 'Having papupata call the implementation',\n              anchor: 'directMakeRequest',\n              level: 1,\n              content: (\n                <>\n                  <p>\n                    You can configure your tests to act as the papupata client, allowing you to use the normal papupata calls to test your\n                    API. The big advantage is having the syntax be exactly what the real client would use. There is a potential downside for\n                    clarity though: as this approach is focused on unit testing, you might want to reserve this syntax for making API calls\n                    that go through the full middleware stack. If that is the case, consider other options.\n                  </p>\n                  <p>\n                    So, let's configure a client. We are using an experimental adapter for the job; it provides only a very minimal request\n                    and response as well as error handling. If it is too limited for your needs, feel free to use the code for the adapter\n                    to build your own.\n                  </p>\n                  <Example>{`\n                    import createAdapter from 'papupata/dist/main/invokeImplementationAdapter'\n                    API.configure({\n                      ...API.getConfig(),\n                      baseURL: '', // the value is not relevant, but must be a string\n                      makeRequest: createAdapter()\n                    })\n                    const response = await api({id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'})\n                  `}</Example>\n                  <p>The adapters supports a few options that make your life easier:</p>\n                  <ul>\n                    <li>\n                      <FixedFont>createRequest</FixedFont> for setting up the request as you need (with, say, headers, session etc)\n                      <Example>{`\n                        const makeRequest = createAdapter({\n                          createRequest: () => ({ headers: { 'authorization': 'bearer 123'}}) \n                        })\n                      `}</Example>\n                    </li>\n                    <li>\n                      <FixedFont>assertResponse</FixedFont> for making assertions about the response beyond just the data\n                      <Example>{`\n                        const makeRequest = createAdapter({\n                          assertResponse: res => expect(res.statusCode).toEqual(400) \n                        })\n                      `}</Example>\n                    </li>\n                    <li>\n                      <FixedFont>withMiddleware</FixedFont>, which enables the use of middleware for the request\n                      <Example>{`\n                        const makeRequest = createAdapter({\n                          withMiddleware: true\n                        })\n                      `}</Example>\n                    </li>\n                  </ul>\n                </>\n              )\n            },\n            {\n              heading: 'Call the implementation with a helper function',\n              anchor: 'directWithHelper',\n              level: 1,\n              content: (\n                <>\n                  <p>\n                    With properly designed helper function you can call the implementation indirectly with full type safety. Papupata comes\n                    with an experimental function that might or might not be good enough for your use case. If you need additional features,\n                    feel free to use the provided function as a template to work on.\n                  </p>\n                  <Example>{`\n                    import testInvoke from 'papupata/dist/main/testInvoker'\n                    const response = await invoker(api, {id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'})\n                  `}</Example>\n                  <p>The test invoker supports the same options as invokeImplementationAdapter described above.</p>\n                  <Example>{`\n                    const response = await invoker(api, data, { withMiddleware: true })\n                  `}</Example>\n                </>\n              )\n            },\n            {\n              heading: 'Full stack tests',\n              anchor: ' fullStack',\n              content: (\n                <>\n                  <p>For full stack tests you'd be best off setting up papupata to make the calls as if it's the real client.</p>\n                  <p>\n                    If you are setting up the express server with your own code for your tests, you might want to use the request-promise\n                    adapter or write your own if you use something else.\n                  </p>\n                  <Example>{`\n                    import createRequestAdapter from 'papupata/dist/main/requestPromiseAdapter'\n                    API.configure({\n                      ...API.getConfig(),\n                      baseURL: \\`http://localhost:\\${port}\\`\n                      makeRequest: createRequestAdapter('json')\n                    })\n                    const response = await api({id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'})\n                  `}</Example>\n                  <p>If you are using supertest, you can use adapter specifically made for it instead.</p>\n                  <Example>{`\n                    import createSupertestAdapter from 'papupata/dist/main/supertestAdapter'\n\n                    const supertestRequest = supertest(app) // express app\n                    API.configure({                      \n                      ...API.getConfig(),\n                      baseURL: '', // The value must be an empty string\n                      makeRequest: createSupertestAdapter(supertestRequest)\n                    })\n                    const response = await api({id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'})\n                  `}</Example>\n                  <p>If you wish to access the actual supertest request for your assertions, you can instead use supertest invoker.</p>\n                  <Example>{`\n                    import supertestInvoker from 'papupata/dist/main/supertestInvoker'\n\n                    API.configure({                      \n                      ...API.getConfig(),\n                      baseURL: '', // The value must be an empty string\n                    })\n                    \n                    const supertestRequest = supertest(app) // express app\n                    const data = {id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'}\n\n                    await invokeSupertest(supertestRequest, api, data)\n                      .expect(200)                    \n                  `}</Example>\n                </>\n              )\n            }\n          ]}\n        />\n      </Container>\n    </Page>\n  </IndexLayout>\n)\n\nexport default IndexPage\n","import * as React from 'react'\n\nexport const IncludeAvailableFromContext = React.createContext(false)\n","import styled from 'styled-components'\r\nimport React, { ReactNode } from 'react'\r\nimport { Code } from './Code'\r\nimport { IncludeAvailableFromContext } from './IncludeAvailableFromContext'\r\n\r\nexport const Section = styled.section``\r\nexport const SectionHeading = styled.h4``\r\nexport const SubHeading = styled.h5``\r\nexport const ExampleCommonContainer = styled.section`\r\n  padding: 15px 30px;\r\n  background: lightyellow;\r\n`\r\n\r\nexport const Purpose: React.FC = ({ children }) => {\r\n  return (\r\n    <Section>\r\n      <SectionHeading>Purpose</SectionHeading>\r\n      {children}\r\n    </Section>\r\n  )\r\n}\r\n\r\nexport type ValidVersions = '1.1.0' | '1.2.0' | '1.5.0' | '1.8.0'\r\nexport const AvailableFrom = ({ version }: { version: ValidVersions }) => {\r\n  return (\r\n    <Section>\r\n      <SectionHeading>Availability</SectionHeading>\r\n      This functionality is available from papupata version {version} onwards.\r\n    </Section>\r\n  )\r\n}\r\n\r\nexport const Usage: React.FC = ({ children }) => {\r\n  return (\r\n    <Section>\r\n      <SectionHeading>Usage</SectionHeading>\r\n      {children}\r\n    </Section>\r\n  )\r\n}\r\nexport const Parameters: React.FC<{ includeAvailableFrom?: boolean; label?: string }> = ({ children, includeAvailableFrom, label }) => {\r\n  return (\r\n    <Section>\r\n      <IncludeAvailableFromContext.Provider value={!!includeAvailableFrom}>\r\n        <SectionHeading>Parameters{label && `: ${label}`}</SectionHeading>\r\n        {children ? (\r\n          <table>\r\n            <thead>\r\n              <tr>\r\n                <th>Name</th>\r\n                <th>Type</th>\r\n                <th>Description</th>\r\n                {includeAvailableFrom && <th>Introduced in</th>}\r\n              </tr>\r\n            </thead>\r\n            <tbody>{children}</tbody>\r\n          </table>\r\n        ) : (\r\n          <p>There are no parameters.</p>\r\n        )}\r\n      </IncludeAvailableFromContext.Provider>\r\n    </Section>\r\n  )\r\n}\r\n\r\nexport const Parameter: React.FC<{ name: string; dataType: any; availableFrom?: ValidVersions }> = ({\r\n  children,\r\n  name,\r\n  dataType,\r\n  availableFrom = '1.0.0'\r\n}) => {\r\n  const includeAvailableFrom = React.useContext(IncludeAvailableFromContext)\r\n  return (\r\n    <tr>\r\n      <td>{name}</td>\r\n      <td>{dataType}</td>\r\n      <td>{children}</td>\r\n      {includeAvailableFrom && <td>{availableFrom}</td>}\r\n    </tr>\r\n  )\r\n}\r\n\r\nexport const MethodReturnType: React.FC = ({ children }) => {\r\n  return (\r\n    <Section>\r\n      <SectionHeading>Returns</SectionHeading>\r\n      {children}\r\n    </Section>\r\n  )\r\n}\r\n\r\nexport const Caveats: React.FC = ({ children }) => {\r\n  return (\r\n    <Section>\r\n      <SectionHeading>Caveats</SectionHeading>\r\n      {children}\r\n    </Section>\r\n  )\r\n}\r\nexport const Examples: React.FC<{ children: any }> = ({ children }) => {\r\n  return (\r\n    <Section>\r\n      <SectionHeading>Examples</SectionHeading>\r\n      {children}\r\n    </Section>\r\n  )\r\n}\r\n\r\nexport const Example: React.FC<{ label?: string; children: string }> = ({ children, label }) => {\r\n  return (\r\n    <>\r\n      {label && <SubHeading>{label}</SubHeading>}\r\n      <Code language={'typescript'}>{children}</Code>\r\n    </>\r\n  )\r\n}\r\n\r\nexport const ExampleCommon: React.FC<{ children: any }> = ({ children }) => {\r\n  return (\r\n    <ExampleCommonContainer>\r\n      <SubHeading>Common to examples below:</SubHeading>\r\n      {children}\r\n    </ExampleCommonContainer>\r\n  )\r\n}\r\n\r\nexport const TypeParameters: React.FC<{ children: ReactNode; includeAvailableFrom?: boolean }> = ({ children, includeAvailableFrom }) => {\r\n  return (\r\n    <Section>\r\n      <SectionHeading>Type parameeters</SectionHeading>\r\n      <IncludeAvailableFromContext.Provider value={!!includeAvailableFrom}>\r\n        <SectionHeading>Parameters</SectionHeading>\r\n        {children ? (\r\n          <table>\r\n            <thead>\r\n              <tr>\r\n                <th>Name</th>\r\n                <th>Default value</th>\r\n                <th>Description</th>\r\n                {includeAvailableFrom ? <th>Introduced in</th> : ''}\r\n              </tr>\r\n            </thead>\r\n            <tbody>{children}</tbody>\r\n          </table>\r\n        ) : (\r\n          <p>There are no parameters.</p>\r\n        )}\r\n      </IncludeAvailableFromContext.Provider>\r\n    </Section>\r\n  )\r\n}\r\n\r\nconst Row = styled.tr``\r\nconst NameColumn = styled.td``\r\nconst DefaultValueColumn = styled.td``\r\nconst DescriptionColumn = styled.td``\r\nconst AvailableFromColumn = styled.td``\r\n\r\nexport const TypeParameter: React.FC<{ name: string; defaultValue?: string; availableFrom?: string }> = ({\r\n  children,\r\n  name,\r\n  defaultValue,\r\n  availableFrom = 'none'\r\n}) => {\r\n  const includeAvailableFrom = React.useContext(IncludeAvailableFromContext)\r\n  return (\r\n    <Row>\r\n      <NameColumn>{name}</NameColumn>\r\n      <DefaultValueColumn>{defaultValue}</DefaultValueColumn>\r\n      <DescriptionColumn>{children}</DescriptionColumn>\r\n      {includeAvailableFrom ? <AvailableFromColumn>{availableFrom}</AvailableFromColumn> : ''}\r\n    </Row>\r\n  )\r\n}\r\n","import React, { ReactNode } from 'react'\nimport { Section, SectionHeading } from './api-components'\nimport styled from 'styled-components'\n\nexport function Overview({ children }: { children: ReactNode }) {\n  return (\n    <Section>\n      <SectionHeading>Overview</SectionHeading>\n      {children}\n    </Section>\n  )\n}\n\ninterface GuidePart {\n  heading: ReactNode\n  anchor: string\n  content: ReactNode\n  level?: number\n}\n\nconst Level0 = styled.h4``\nconst Level1= styled.h5`\n  font-size: 1.1em;\n`\n\nexport function GuideContent({ content }: { content: GuidePart[] }) {\n  return (\n    <div>\n      <Section>\n        <SectionHeading>Table of contents</SectionHeading>\n        <ul>\n          {content.map(child => (\n            <li style={{ marginLeft: 18 * (child.level || 0) }} key={child.anchor}>\n              <a href={`#${child.anchor}`}>{child.heading}</a>\n            </li>\n          ))}\n        </ul>\n      </Section>\n      {content.map(child => {\n        const Heading = !child.level ? Level0 : Level1\n        return (\n          <Section id={child.anchor} key={child.anchor}>\n            <Heading>{child.heading}</Heading>\n            {child.content}\n          </Section>\n        )\n      })}\n    </div>\n  )\n}\n\nexport const FixedFont = styled.span`\n  font-family: \"Consolas\", \"Bitstream Vera Sans Mono\", \"Courier New\", Courier, monospace\n`\n"],"sourceRoot":""}