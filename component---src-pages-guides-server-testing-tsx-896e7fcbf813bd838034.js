(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{503:function(e,t,n){"use strict";n.r(t);var a=n(1),o=n(439),s=n(135),i=n(509),r=n(440),u=n(441),l=n(0);t.default=function(){return Object(l.d)(u.a,null,Object(l.d)(r.a,null,Object(l.d)(s.a,null,Object(l.d)("h1",null,"Guide: testing APIs"),Object(l.d)(i.c,null,"Testing can be tricky. This guide provides some ideas on how you could test APIs implemented using papupata."),Object(l.d)(i.b,{content:[{heading:"Before starting",anchor:"before",content:Object(l.d)("div",null,Object(l.d)("p",null,"The following is assumed to be present for the examples in this guide:"),Object(l.d)(o.c,null,"\n                  import {APIDeclaration} from 'papupata'\n                  const API = new APIDeclaration()\n\n                  const complexAPI = API.declarePostAPI('/update/:id', routeOptions)\n                    .params(['id'] as const)\n                    .query(['author'] as const)\n                    .optionalQuery(['timestamp'] as const)\n                    .queryBool(['notifyWatchers'] as const)\n                    .body<{ name: string}>()\n                    .response<{status: string }>()\n                "))},{heading:"The Basics",anchor:"basics",content:Object(l.d)(a.Fragment,null,Object(l.d)("p",null,"As papupata is typically used as a part of an express application you always have the option of using whatever tools you use to test the rest of your express application."),Object(l.d)("p",null,"The key to doing this is setting up a base URL on the papupata APIDeclaration and then using the getURL method of the individual APIs to figure out what to call."),Object(l.d)(o.c,null,"\n                    API.configure({baseURL: 'http://localhost:3000'})\n\n                    const response = await request.post(api.getURL({}))\n                    expect(request).toEqual({ok: true})\n                  "),Object(l.d)("p",null,"There are a few downsides to doing this, though. For one, you are not taking advantage of types present in the APIs, so typescript will not be able to warn you if you are sending invalid data to the API. Second, by having the whole express application present you are testing the whole server implementation, including middleware, even if you wanted to do unit testing."),Object(l.d)("p",null,"Let's look into some other options"))},{heading:"Just testing the implementation",anchor:"implementation",content:Object(l.d)(a.Fragment,null,Object(l.d)("p",null,"For the purpose of unit testing, you'll probably want to test just the implementation of the API. Once implemented, the actual implementation can be accessed as ",Object(l.d)(i.a,null,"api.implementation"),". You can call it directly from your tests, although you might find it inconvenient because you have to supply request and response to the function."),Object(l.d)(o.c,null,"\n                    const response = await api.implementation(request, response)\n                  "),Object(l.d)("p",null,"In practice, you'll want a helper of some kind to deal with setting up the objects."))},{heading:"Having papupata call the implementation",anchor:"directMakeRequest",level:1,content:Object(l.d)(a.Fragment,null,Object(l.d)("p",null,"You can configure your tests to act as the papupata client, allowing you to use the normal papupata calls to test your API. The big advantage is having the syntax be exactly what the real client would use. There is a potential downside for clarity though: as this approach is focused on unit testing, you might want to reserve this syntax for making API calls that go through the full middleware stack. If that is the case, consider other options."),Object(l.d)("p",null,"So, let's configure a client. We are using an experimental adapter for the job; it provides only a very minimal request and response as well as error handling. If it is too limited for your needs, feel free to use the code for the adapter to build your own."),Object(l.d)(o.c,null,"\n                    import createAdapter from 'papupata/dist/main/invokeImplementationAdapter'\n                    API.configure({\n                      ...API.getConfig(),\n                      baseURL: '', // the value is not relevant, but must be a string\n                      makeRequest: createAdapter()\n                    })\n                    const response = await api({id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'})\n                  "),Object(l.d)("p",null,"The adapters supports a few options that make your life easier:"),Object(l.d)("ul",null,Object(l.d)("li",null,Object(l.d)(i.a,null,"createRequest")," for setting up the request as you need (with, say, headers, session etc)",Object(l.d)(o.c,null,"\n                        const makeRequest = createAdapter({\n                          createRequest: () => ({ headers: { 'authorization': 'bearer 123'}}) \n                        })\n                      ")),Object(l.d)("li",null,Object(l.d)(i.a,null,"assertResponse")," for making assertions about the response beyond just the data",Object(l.d)(o.c,null,"\n                        const makeRequest = createAdapter({\n                          assertResponse: res => expect(res.statusCode).toEqual(400) \n                        })\n                      ")),Object(l.d)("li",null,Object(l.d)(i.a,null,"withMiddleware"),", which enables the use of middleware for the request",Object(l.d)(o.c,null,"\n                        const makeRequest = createAdapter({\n                          withMiddleware: true\n                        })\n                      "))))},{heading:"Call the implementation with a helper function",anchor:"directWithHelper",level:1,content:Object(l.d)(a.Fragment,null,Object(l.d)("p",null,"With properly designed helper function you can call the implementation indirectly with full type safety. Papupata comes with an experimental function that might or might not be good enough for your use case. If you need additional features, feel free to use the provided function as a template to work on."),Object(l.d)(o.c,null,"\n                    import testInvoke from 'papupata/dist/main/testInvoker'\n                    const response = await invoker(api, {id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'})\n                  "),Object(l.d)("p",null,"The test invoker supports the same options as invokeImplementationAdapter described above."),Object(l.d)(o.c,null,"\n                    const response = await invoker(api, data, { withMiddleware: true })\n                  "))},{heading:"Full stack tests",anchor:" fullStack",content:Object(l.d)(a.Fragment,null,Object(l.d)("p",null,"For full stack tests you'd be best off setting up papupata to make the calls as if it's the real client."),Object(l.d)("p",null,"If you are setting up the express server with your own code for your tests, you might want to use the request-promise adapter or write your own if you use something else."),Object(l.d)(o.c,null,"\n                    import createRequestAdapter from 'papupata/dist/main/requestPromiseAdapter'\n                    API.configure({\n                      ...API.getConfig(),\n                      baseURL: `http://localhost:${port}`\n                      makeRequest: createRequestAdapter('json')\n                    })\n                    const response = await api({id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'})\n                  "),Object(l.d)("p",null,"If you are using supertest, you can use adapter specifically made for it instead."),Object(l.d)(o.c,null,"\n                    import createSupertestAdapter from 'papupata/dist/main/supertestAdapter'\n\n                    const supertestRequest = supertest(app) // express app\n                    API.configure({                      \n                      ...API.getConfig(),\n                      baseURL: '', // The value must be an empty string\n                      makeRequest: createSupertestAdapter(supertestRequest)\n                    })\n                    const response = await api({id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'})\n                  "),Object(l.d)("p",null,"If you wish to access the actual supertest request for your assertions, you can instead use supertest invoker."),Object(l.d)(o.c,null,"\n                    import supertestInvoker from 'papupata/dist/main/supertestInvoker'\n\n                    API.configure({                      \n                      ...API.getConfig(),\n                      baseURL: '', // The value must be an empty string\n                    })\n                    \n                    const supertestRequest = supertest(app) // express app\n                    const data = {id: '1', author: 'Sinead', notifyWatchers: false, name: 'Ulrich'}\n\n                    await invokeSupertest(supertestRequest, api, data)\n                      .expect(200)                    \n                  "))}]}))))}},509:function(e,t,n){"use strict";n.d(t,"c",(function(){return c})),n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return f}));n(510),n(1);var a=n(439),o=n(4),s=n(0);function i(){var e=l(['\n  font-family: "Consolas", "Bitstream Vera Sans Mono", "Courier New", Courier, monospace\n']);return i=function(){return e},e}function r(){var e=l(["\n  font-size: 1.1em;\n"]);return r=function(){return e},e}function u(){var e=l([""]);return u=function(){return e},e}function l(e,t){return t||(t=e.slice(0)),e.raw=t,e}function c(e){var t=e.children;return Object(s.d)(a.j,null,Object(s.d)(a.k,null,"Overview"),t)}var p=o.a.h4(u()),d=o.a.h5(r());function h(e){var t=e.content;return Object(s.d)("div",null,Object(s.d)(a.j,null,Object(s.d)(a.k,null,"Table of contents"),Object(s.d)("ul",null,t.map((function(e){return Object(s.d)("li",{style:{marginLeft:18*(e.level||0)},key:e.anchor},Object(s.d)("a",{href:"#"+e.anchor},e.heading))})))),t.map((function(e){var t=e.level?d:p;return Object(s.d)(a.j,{id:e.anchor,key:e.anchor},Object(s.d)(t,null,e.heading),e.content)})))}var f=o.a.span(i())},510:function(e,t,n){"use strict";n(109)("anchor",(function(e){return function(t){return e(this,"a","name",t)}}))}}]);
//# sourceMappingURL=component---src-pages-guides-server-testing-tsx-896e7fcbf813bd838034.js.map